name: Scrape Golf Data

on:
  workflow_dispatch:  # Permet de dÃ©clencher manuellement depuis l'onglet Actions
  schedule:
    - cron: '0 3 1 * *'  # ExÃ©cute le 1er de chaque mois Ã  3h du matin UTC

jobs:
  scrape-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run scraper
      run: |
        python src/ffgolf_scraper.py --all --delay 0.5 --output golfs_france.xlsx
    
    - name: Get current date and time
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
    
    - name: Get golf statistics
      id: stats
      run: |
        python -c "
        import pandas as pd
        df = pd.read_excel('golfs_france.xlsx')
        print(f'total_golfs={len(df)}')
        print(f'total_regions={df[\"region\"].nunique()}')
        " >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: data-${{ steps.date.outputs.date }}
        name: DonnÃ©es Golfs France - ${{ steps.date.outputs.date }}
        body: |
          ## ğŸ“Š DonnÃ©es des terrains de golf en France
          
          DonnÃ©es extraites le **${{ steps.date.outputs.date }}** depuis [FFGolf.org](https://www.ffgolf.org)
          
          ### Statistiques
          - ğŸŒï¸ **${{ steps.stats.outputs.total_golfs }}** terrains de golf
          - ğŸ“ **${{ steps.stats.outputs.total_regions }}** rÃ©gions couvertes
          
          ### ğŸ“¥ TÃ©lÃ©chargement
          TÃ©lÃ©chargez le fichier Excel ci-dessous pour accÃ©der Ã  toutes les donnÃ©es.
          
          ### ğŸ“‹ Colonnes incluses
          - RÃ©gion
          - Nom du golf
          - Adresse
          - TÃ©lÃ©phone
          - Email
          - Site web
          - URL FFGolf
          
          ---
          
          *DonnÃ©es collectÃ©es de maniÃ¨re respectueuse avec un dÃ©lai de 0.5 secondes entre chaque requÃªte.*
        files: golfs_france.xlsx
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    - name: Delete old releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 12  # Garde les 12 derniÃ¨res releases (1 an si mensuel)
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
